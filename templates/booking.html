<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Booking - Gustino's SPA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_slug }}">
</head>
<body>
  <main class="card">
    <h1>ðŸ“… Book Your Massage</h1>
    <p>Welcome, <strong>{{ user.email }}</strong></p>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}

    <form method="POST" id="booking-form">
      <label for="date">Select Date</label>
      <select id="date" name="date" onchange="renderTimes()">
        {% for d, slots in slots_by_date.items() %}
          <option value="{{ d }}" {% if d == default_date %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>

      <label for="time">Select 2-hour slot</label>
      <select id="time" name="start"></select>
      <input type="hidden" name="end" id="end">

      <div style="margin-top: 12px;">
        <button type="submit">Reserve Selected Slot</button>
      </div>
    </form>

    <h2>Your Reservations</h2>
    {% if user_bookings %}
      <table>
        <thead><tr><th>Date</th><th>Start</th><th>End</th></tr></thead>
        <tbody>
          {% for b in user_bookings %}
            <tr><td>{{ b.date }}</td><td>{{ b.start }}</td><td>{{ b.end }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p><em>No reservations yet.</em></p>
    {% endif %}
  </main>

<script>
  const slots = {{ slots_by_date|tojson }};
  const dateSelect = document.getElementById('date');
  const timeSelect = document.getElementById('time');
  const endInput = document.getElementById('end');

  function renderTimes() {
    const d = dateSelect.value;
    const daySlots = slots[d] || [];
    timeSelect.innerHTML = '';
    endInput.value = '';

    daySlots.forEach(([start, end]) => {
      const opt = document.createElement('option');
      opt.value = start;
      opt.textContent = `${start} â€” ${end}`;
      opt.dataset.end = end;
      timeSelect.appendChild(opt);
    });

    if (timeSelect.options.length > 0) {
      endInput.value = timeSelect.options[0].dataset.end;
    }
  }

  timeSelect?.addEventListener('change', (e) => {
    const selected = e.target.selectedOptions[0];
    if (selected) endInput.value = selected.dataset.end;
  });

  // initial render
  renderTimes();
</script>
</body>
</html>
